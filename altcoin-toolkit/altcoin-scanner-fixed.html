<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Altcoin Strength Scanner - Panic Drop | Trading Tool</title>
    <meta name="description" content="Advanced crypto market intelligence and strength analysis tool by Timothy Assi, eToro Elite Popular Investor.">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }
        
        .api-status.live {
            background: var(--accent-success);
            color: white;
        }
        
        .api-status.demo {
            background: var(--accent-primary);
            color: white;
        }
        
        .api-status.error {
            background: var(--accent-danger);
            color: white;
        }

        .tool-hero {
            padding: 20px 20px 50px;
            text-align: center;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin-top: 0;
        }
        
        .tool-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-weight: 800;
        }
        
        .tool-hero h1 i {
            color: var(--accent-primary);
            margin-right: 15px;
        }
        
        .tool-hero p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .scanner-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-title i {
            color: var(--accent-primary);
            font-size: 1.5rem;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .results-section {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--accent-primary);
            font-size: 1.5rem;
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .token-card {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .token-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
            border-color: var(--accent-primary);
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .token-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .token-symbol {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .token-score {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .token-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .token-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .price-info {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .price-change {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .price-change.positive {
            color: var(--accent-success);
        }

        .price-change.negative {
            color: var(--accent-danger);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-panel {
            background: var(--secondary-bg);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            accent-color: var(--accent-primary);
        }

        .analysis-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Analysis Modal */
        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            background: var(--secondary-bg);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title .token-symbol {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--primary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background: rgba(0, 168, 255, 0.1);
        }

        /* Tab Content */
        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .analysis-section {
            margin-bottom: 25px;
        }

        .analysis-section h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-section h3 i {
            color: var(--accent-primary);
        }

        .analysis-text {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 1rem;
        }

        .analysis-text h4 {
            color: var(--text-primary);
            font-weight: 600;
            margin: 20px 0 10px 0;
        }

        .analysis-text ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .analysis-text li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .analysis-text strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: var(--primary-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .metric-value {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .loading-analysis {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .loading-analysis i {
            font-size: 2.5rem;
            color: var(--accent-primary);
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        .loading-analysis .loading-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .loading-analysis .loading-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .error-state i {
            font-size: 2.5rem;
            color: var(--accent-danger);
            margin-bottom: 15px;
        }

        .error-state .error-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .retry-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .tool-hero h1 {
                font-size: 2rem;
            }
            
            .token-grid {
                grid-template-columns: 1fr;
            }
            
            .control-header {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }

            .modal-header {
                padding: 20px;
            }

            .tab-content {
                padding: 20px;
            }

            .tab-btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="../index.html">
                    <img src="../images/logo.png" alt="Panic Drop Logo" onerror="this.style.display='none'">
                    <span class="logo-text">Panic Drop</span>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../index.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="../course.html" class="nav-link">Course</a>
                </li>
                <li class="nav-item">
                    <a href="../blog.html" class="nav-link">Blog</a>
                </li>
                <li class="nav-item dropdown">
                    <div class="nav-link dropdown-toggle">
                        <a href="#" class="main-link">Tools</a>
                        <span class="toggle-arrow"></span>
                    </div>
                    <div class="dropdown-content">
                        <a href="position-calculator.html">Position Calculator</a>
                        <a href="trade-journal.html">Trade Journal</a>
                        <a href="screenshot-analyzer.html">Screenshot Analyzer</a>
                        <a href="altcoin-strength-scanner.html">Altcoin Strength Scanner</a>
                        <a href="altcoin-scanner-fixed.html" class="active">Altcoin Scanner (Fixed)</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="../contact.html" class="nav-link">Contact</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Include navigation script -->
    <script src="../js/script.js"></script>
    
    <!-- API Status Indicator -->
    <div id="apiStatus" class="api-status demo">🔄 Loading...</div>

    <!-- Tool Hero Section -->
    <section class="tool-hero">
        <h1><i class="fas fa-chart-line"></i>Altcoin Strength Scanner</h1>
        <p>AI-powered analysis of the strongest altcoins based on comprehensive market intelligence and real-time data.</p>
    </section>

    <!-- Main Scanner Interface -->
    <main class="scanner-main">
        <!-- Control Panel -->
        <section class="control-panel">
            <div class="control-header">
                <div class="control-title">
                    <i class="fas fa-cog"></i>
                    Scanner Controls
                </div>
                <button class="btn btn-primary" onclick="startAnalysis()">
                    <i class="fas fa-play"></i>
                    Start Analysis
                </button>
            </div>
            
            <!-- Filter Panel -->
            <div class="filter-panel">
                <div class="filter-group">
                    <label class="filter-label">Category Filter</label>
                    <select id="categoryFilter" class="filter-select">
                        <option value="all">All Categories</option>
                        <option value="defi">DeFi</option>
                        <option value="layer1">Layer 1</option>
                        <option value="layer2">Layer 2</option>
                        <option value="ai">AI & Big Data</option>
                        <option value="gaming">Gaming & Metaverse</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Market Cap Range</label>
                    <select id="marketCapFilter" class="filter-select">
                        <option value="all">All Market Caps</option>
                        <option value="large">Large Cap ($1B+)</option>
                        <option value="mid">Mid Cap ($100M-$1B)</option>
                        <option value="small">Small Cap ($10M-$100M)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="excludeStablecoins">
                            <span>Exclude Stablecoins</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="excludeMemecoins">
                            <span>Exclude Memecoins</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Sections -->
        <section class="results-section">
            <div class="section-title">
                <i class="fas fa-fire"></i>
                Trending Narrative Tokens
            </div>
            <div id="narrativeResults" class="token-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Click "Start Analysis" to begin scanning...</div>
                </div>
            </div>
        </section>

        <section class="results-section">
            <div class="section-title">
                <i class="fas fa-laugh"></i>
                Top Meme Coins
            </div>
            <div id="memeResults" class="token-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Click "Start Analysis" to begin scanning...</div>
                </div>
            </div>
        </section>

        <section class="results-section">
            <div class="section-title">
                <i class="fas fa-network-wired"></i>
                Network Adoption Leaders
            </div>
            <div id="networkResults" class="token-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Click "Start Analysis" to begin scanning...</div>
                </div>
            </div>
        </section>

        <section class="results-section">
            <div class="section-title">
                <i class="fas fa-trophy"></i>
                Overall Top Performers
            </div>
            <div id="overallResults" class="token-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Click "Start Analysis" to begin scanning...</div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global variables
        let cryptoData = [];
        let isAnalysisRunning = false;

        // Initialize scanner
        document.addEventListener('DOMContentLoaded', function() {
            updateApiStatus('demo', '🔄 Ready to scan');
            loadCryptoData();
        });

        // Load crypto data from CMC API
        async function loadCryptoData() {
            try {
                console.log('📡 Loading crypto data...');
                const response = await fetch('/api/cryptoListings');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.data && data.data.length > 0) {
                    cryptoData = data.data;
                    console.log(`✅ Loaded ${cryptoData.length} cryptocurrencies`);
                    updateApiStatus('live', '✅ Live Data Connected');
                } else {
                    throw new Error('No cryptocurrency data received');
                }
                
            } catch (error) {
                console.error('❌ Failed to load crypto data:', error);
                updateApiStatus('error', '❌ Data Error');
            }
        }

        // Start comprehensive analysis
        async function startAnalysis() {
            if (isAnalysisRunning) return;
            
            isAnalysisRunning = true;
            updateApiStatus('demo', '🔄 Analyzing...');
            
            try {
                // Get filter values
                const filters = {
                    category: document.getElementById('categoryFilter').value,
                    marketCap: document.getElementById('marketCapFilter').value,
                    excludeStablecoins: document.getElementById('excludeStablecoins').checked,
                    excludeMemecoins: document.getElementById('excludeMemecoins').checked
                };

                console.log('🔍 Starting analysis with filters:', filters);

                // Update loading states
                setLoadingState('narrativeResults');
                setLoadingState('memeResults');
                setLoadingState('networkResults');
                setLoadingState('overallResults');

                // Run analyses in parallel
                const [narrativeResults, memeResults, networkResults, overallResults] = await Promise.all([
                    analyzeNarrativeTokens(filters),
                    analyzeMemeTokens(filters),
                    analyzeNetworkTokens(filters),
                    analyzeOverallTokens(filters)
                ]);

                // Display results
                displayResults('narrativeResults', narrativeResults);
                displayResults('memeResults', memeResults);
                displayResults('networkResults', networkResults);
                displayResults('overallResults', overallResults);

                updateApiStatus('live', '✅ Analysis Complete');
                
            } catch (error) {
                console.error('❌ Analysis failed:', error);
                updateApiStatus('error', '❌ Analysis Error');
            } finally {
                isAnalysisRunning = false;
            }
        }

        // Analyze narrative tokens
        async function analyzeNarrativeTokens(filters) {
            const prompt = buildPrompt('narrative', filters);
            return await getAIAnalysis(prompt);
        }

        // Analyze meme tokens
        async function analyzeMemeTokens(filters) {
            const prompt = buildPrompt('meme', filters);
            return await getAIAnalysis(prompt);
        }

        // Analyze network tokens
        async function analyzeNetworkTokens(filters) {
            const prompt = buildPrompt('network', filters);
            return await getAIAnalysis(prompt);
        }

        // Analyze overall tokens
        async function analyzeOverallTokens(filters) {
            const prompt = buildPrompt('overall', filters);
            return await getAIAnalysis(prompt);
        }

        // Build AI prompt based on type and filters
        function buildPrompt(type, filters) {
            let basePrompt = '';
            
            switch (type) {
                case 'narrative':
                    basePrompt = 'List exactly 3 different altcoins driving trending crypto narratives';
                    break;
                case 'meme':
                    basePrompt = 'List exactly 3 different trending meme cryptocurrencies';
                    break;
                case 'network':
                    basePrompt = 'List exactly 3 different blockchain networks with strong adoption';
                    break;
                case 'overall':
                    basePrompt = 'List exactly 3 different best overall altcoins';
                    break;
            }

            // Add filter criteria
            const criteria = [];
            if (filters.category !== 'all') {
                const categoryMap = {
                    'defi': 'DeFi and decentralized finance',
                    'layer1': 'Layer 1 blockchain networks',
                    'layer2': 'Layer 2 scaling solutions',
                    'ai': 'AI and Big Data related',
                    'gaming': 'Gaming and Metaverse'
                };
                criteria.push(`focus only on ${categoryMap[filters.category]} tokens`);
            }
            
            if (filters.excludeStablecoins) {
                criteria.push('exclude stablecoins like USDT, USDC, DAI');
            }
            
            if (filters.excludeMemecoins && type !== 'meme') {
                criteria.push('exclude meme coins like DOGE, SHIB, PEPE');
            }

            if (criteria.length > 0) {
                basePrompt += ` that meet: ${criteria.join(', ')}`;
            }

            return `${basePrompt}. Format each as:

Token Name (SYMBOL) - Score: XX/100 - Brief description

Example:
Ethereum (ETH) - Score: 85/100 - Leading smart contract platform
Chainlink (LINK) - Score: 78/100 - Decentralized oracle network
Polygon (MATIC) - Score: 72/100 - Layer 2 scaling solution

CRITICAL: NEVER use asterisks, bold formatting, or numbered lists. Provide clean text only.`;
        }

        // Get AI analysis from Perplexity
        async function getAIAnalysis(prompt) {
            try {
                const response = await fetch('/api/perplexityScore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: prompt,
                        maxTokens: 200
                    })
                });

                const data = await response.json();
                console.log('🤖 AI Response:', data);

                let text = '';
                if (data.choices && data.choices[0]) {
                    text = data.choices[0].message.content;
                } else if (data.explanation) {
                    text = data.explanation;
                } else {
                    throw new Error('No AI response received');
                }

                return parseTokenResponse(text);
                
            } catch (error) {
                console.error('❌ AI Analysis failed:', error);
                return getFallbackTokens();
            }
        }

        // Parse AI response into token objects
        function parseTokenResponse(text) {
            const tokens = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                const match = line.match(/^(.*?)\s*\(([A-Z]+)\)\s*-\s*Score:\s*(\d+)\/100\s*-\s*(.*)$/i);
                if (match) {
                    const [, name, symbol, score, description] = match;
                    const coinData = findCoinData(symbol);
                    
                    tokens.push({
                        name: name.trim(),
                        symbol: symbol.trim(),
                        score: parseInt(score),
                        description: description.trim(),
                        price: coinData?.quote?.USD?.price || 0,
                        change24h: coinData?.quote?.USD?.percent_change_24h || 0,
                        marketCap: coinData?.quote?.USD?.market_cap || 0
                    });
                }
            }
            
            return tokens.length > 0 ? tokens : getFallbackTokens();
        }

        // Find coin data from CMC
        function findCoinData(symbol) {
            return cryptoData.find(coin => 
                coin.symbol.toLowerCase() === symbol.toLowerCase()
            );
        }

        // Fallback tokens when AI fails
        function getFallbackTokens() {
            const fallbacks = ['ETH', 'BNB', 'ADA', 'DOT', 'MATIC'];
            return fallbacks.slice(0, 3).map(symbol => {
                const coinData = findCoinData(symbol);
                return {
                    name: coinData?.name || symbol,
                    symbol: symbol,
                    score: Math.floor(Math.random() * 30 + 70),
                    description: 'Market analysis pending - showing live price data',
                    price: coinData?.quote?.USD?.price || 0,
                    change24h: coinData?.quote?.USD?.percent_change_24h || 0,
                    marketCap: coinData?.quote?.USD?.market_cap || 0
                };
            });
        }

        // Display results in grid
        function displayResults(containerId, tokens) {
            const container = document.getElementById(containerId);
            
            if (!tokens || tokens.length === 0) {
                container.innerHTML = '<div class="loading">No tokens found matching criteria</div>';
                return;
            }

            container.innerHTML = tokens.map(token => `
                <div class="token-card">
                    <div class="token-header">
                        <div>
                            <div class="token-name">${token.name}</div>
                            <div class="token-symbol">${token.symbol}</div>
                        </div>
                        <div class="token-score">${token.score}/100</div>
                    </div>
                    <div class="token-description">${token.description}</div>
                    <div class="token-price">
                        <div class="price-info">$${formatPrice(token.price)}</div>
                        <div class="price-change ${token.change24h >= 0 ? 'positive' : 'negative'}">
                            ${token.change24h >= 0 ? '+' : ''}${token.change24h.toFixed(2)}%
                        </div>
                    </div>
                    <button class="analysis-btn" onclick="openDetailedAnalysis('${token.symbol}', '${token.name}')">
                        <i class="fas fa-chart-line"></i>
                        Detailed Analysis
                    </button>
                </div>
            `).join('');
        }

        // Set loading state
        function setLoadingState(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Analyzing tokens...</div>
                </div>
            `;
        }

        // Update API status
        function updateApiStatus(type, message) {
            const statusEl = document.getElementById('apiStatus');
            if (statusEl) {
                statusEl.className = `api-status ${type}`;
                statusEl.textContent = message;
            }
        }

        // Format price
        function formatPrice(price) {
            if (price >= 1) {
                return price.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            } else if (price >= 0.01) {
                return price.toFixed(4);
            } else {
                return price.toFixed(6);
            }
        }

        // Chain detection mapping
        const CHAIN_MAPPING = {
            'BTC': 'Bitcoin',
            'ETH': 'Ethereum',
            'BNB': 'BNB Smart Chain',
            'ADA': 'Cardano',
            'DOT': 'Polkadot',
            'MATIC': 'Polygon',
            'AVAX': 'Avalanche',
            'SOL': 'Solana',
            'ATOM': 'Cosmos',
            'NEAR': 'NEAR Protocol',
            'FTM': 'Fantom',
            'ALGO': 'Algorand',
            'BONK': 'Solana',
            'DOGE': 'Dogecoin',
            'SHIB': 'Ethereum',
            'PEPE': 'Ethereum',
            'LINK': 'Ethereum',
            'UNI': 'Ethereum',
            'AAVE': 'Ethereum',
            'SUSHI': 'Ethereum',
            'CRV': 'Ethereum',
            'COMP': 'Ethereum',
            'MKR': 'Ethereum',
            'YFI': 'Ethereum',
            'SNX': 'Ethereum',
            'BAL': 'Ethereum',
            '1INCH': 'Ethereum',
            'CAKE': 'BNB Smart Chain',
            'JOE': 'Avalanche',
            'GMX': 'Arbitrum',
            'MAGIC': 'Arbitrum',
            'OP': 'Optimism',
            'ARB': 'Arbitrum'
        };

        // Open detailed analysis modal
        async function openDetailedAnalysis(symbol, name) {
            console.log(`🔍 Opening detailed analysis for ${symbol}`);
            
            // Detect chain
            const chain = CHAIN_MAPPING[symbol] || 'Ethereum';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'analysis-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-microscope"></i>
                            ${name} Analysis
                            <span class="token-symbol">${symbol}</span>
                        </div>
                        <button class="close-btn" onclick="closeDetailedAnalysis()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchTab('chain')">
                            <i class="fas fa-network-wired"></i>
                            Chain Analysis
                        </button>
                        <button class="tab-btn" onclick="switchTab('token')">
                            <i class="fas fa-coins"></i>
                            Token Analysis
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="chainTab" class="tab-panel active">
                            <div class="loading-analysis">
                                <i class="fas fa-spinner"></i>
                                <div class="loading-text">Fetching ${chain} chain analysis...</div>
                                <div class="loading-subtext">Analyzing protocols, TVL growth, and sector momentum</div>
                            </div>
                        </div>
                        
                        <div id="tokenTab" class="tab-panel">
                            <div class="loading-analysis">
                                <i class="fas fa-spinner"></i>
                                <div class="loading-text">Fetching ${symbol} token analysis...</div>
                                <div class="loading-subtext">Analyzing emissions, unlocks, and dilution risks</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Add escape key listener
            document.addEventListener('keydown', handleModalEscape);

            // Start analyses
            analyzeChain(chain);
            analyzeToken(symbol, name);
        }

        // Close detailed analysis modal
        function closeDetailedAnalysis() {
            const modal = document.querySelector('.analysis-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
                document.removeEventListener('keydown', handleModalEscape);
            }
        }

        // Handle escape key for modal
        function handleModalEscape(e) {
            if (e.key === 'Escape') {
                closeDetailedAnalysis();
            }
        }

        // Switch between tabs
        function switchTab(tabType) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabType}')"]`).classList.add('active');
            
            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabType}Tab`).classList.add('active');
        }

        // Analyze chain protocols and TVL
        async function analyzeChain(chain) {
            try {
                const currentFilters = getCurrentFilterContext();
                
                const prompt = `Analyze ${chain}'s top protocols by TVL growth over the last 30 days. Search the internet for DeFiLlama or equivalent data sources. Which sectors are gaining momentum? Highlight protocols with >20% growth.

${currentFilters ? `Context: Focus on ${currentFilters} within ${chain} ecosystem.` : ''}

Provide analysis covering:

1. FASTEST-GROWING PROTOCOLS (>20% TVL growth):
   • Protocol name and sector
   • TVL growth percentage
   • Key drivers of growth

2. SECTOR TRENDS:
   • Which sectors (RWA, AI, L2s, DeFi, Gaming) are gaining momentum
   • Emerging narratives
   • Capital flow patterns

3. NARRATIVE ROTATION SIGNALS:
   • Early signs of new narrative adoption
   • Institutional interest indicators
   • Developer activity trends

Format as clean text with clear headings and bullet points. NEVER use asterisks (*) or markdown formatting.`;

                const response = await fetch('/api/perplexityScore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: prompt,
                        maxTokens: 400
                    })
                });

                const data = await response.json();
                let analysisText = '';
                
                if (data.choices && data.choices[0]) {
                    analysisText = data.choices[0].message.content;
                } else if (data.explanation) {
                    analysisText = data.explanation;
                } else {
                    throw new Error('No analysis received');
                }

                // Clean and format the analysis
                const cleanedAnalysis = cleanAnalysisText(analysisText);
                displayChainAnalysis(cleanedAnalysis, chain);
                
            } catch (error) {
                console.error('❌ Chain analysis failed:', error);
                displayChainError(chain);
            }
        }

        // Analyze token metrics and unlocks
        async function analyzeToken(symbol, name) {
            try {
                const prompt = `Analyze ${symbol} (${name})'s emissions, unlock schedule, inflation rate, and FDV vs circulating market cap. Note any risks.

Provide detailed analysis covering:

1. UNLOCK TIMELINE:
   • Clear dates for upcoming unlocks
   • Size of each unlock event
   • Recipients (VCs, team, community)

2. INFLATION & DILUTION:
   • Annual inflation rate percentage
   • Dilution risk explanation
   • Impact on token price pressure

3. TOKENOMICS STRUCTURE:
   • FDV vs circulating market cap ratio
   • Total supply vs circulating supply
   • Emission schedule details

4. RISK ASSESSMENT:
   • Major unlock events to watch
   • Dilution timing risks
   • Comparison to similar tokens

Format as clean text with clear headings and specific numbers. NEVER use asterisks (*) or markdown formatting.`;

                const response = await fetch('/api/perplexityScore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: prompt,
                        maxTokens: 400
                    })
                });

                const data = await response.json();
                let analysisText = '';
                
                if (data.choices && data.choices[0]) {
                    analysisText = data.choices[0].message.content;
                } else if (data.explanation) {
                    analysisText = data.explanation;
                } else {
                    throw new Error('No analysis received');
                }

                // Clean and format the analysis
                const cleanedAnalysis = cleanAnalysisText(analysisText);
                displayTokenAnalysis(cleanedAnalysis, symbol);
                
            } catch (error) {
                console.error('❌ Token analysis failed:', error);
                displayTokenError(symbol);
            }
        }

        // Get current filter context for analysis
        function getCurrentFilterContext() {
            const category = document.getElementById('categoryFilter')?.value;
            const marketCap = document.getElementById('marketCapFilter')?.value;
            
            let context = '';
            if (category && category !== 'all') {
                const categoryMap = {
                    'defi': 'DeFi protocols',
                    'layer1': 'Layer 1 blockchain networks',
                    'layer2': 'Layer 2 scaling solutions',
                    'ai': 'AI and Big Data projects',
                    'gaming': 'Gaming and Metaverse projects'
                };
                context = categoryMap[category];
            }
            
            return context;
        }

        // Clean analysis text from markdown artifacts
        function cleanAnalysisText(text) {
            if (!text) return 'No analysis available.';
            
            let cleanText = text.toString().trim();
            
            // Ultra-aggressive cleaning
            for (let i = 0; i < 5; i++) {
                cleanText = cleanText
                    .replace(/\*\*(.*?)\*\*/g, '$1')
                    .replace(/\*([^*\n]+)\*/g, '$1')
                    .replace(/\*/g, '')
                    .replace(/\[([^\]]*)\]/g, '')
                    .replace(/#{1,6}\s*/g, '')
                    .replace(/`([^`]*)`/g, '$1')
                    .replace(/_{2,}/g, '')
                    .replace(/_([^_\n]+)_/g, '$1')
                    .replace(/\n{3,}/g, '\n\n');
            }
            
            return cleanText || 'Analysis information available.';
        }

        // Display chain analysis results
        function displayChainAnalysis(analysis, chain) {
            const chainTab = document.getElementById('chainTab');
            if (!chainTab) return;
            
            chainTab.innerHTML = `
                <div class="analysis-section">
                    <h3><i class="fas fa-network-wired"></i>${chain} Chain Analysis</h3>
                    <div class="analysis-text">${formatAnalysisText(analysis)}</div>
                </div>
            `;
        }

        // Display token analysis results
        function displayTokenAnalysis(analysis, symbol) {
            const tokenTab = document.getElementById('tokenTab');
            if (!tokenTab) return;
            
            tokenTab.innerHTML = `
                <div class="analysis-section">
                    <h3><i class="fas fa-coins"></i>${symbol} Token Analysis</h3>
                    <div class="analysis-text">${formatAnalysisText(analysis)}</div>
                </div>
            `;
        }

        // Display chain analysis error
        function displayChainError(chain) {
            const chainTab = document.getElementById('chainTab');
            if (!chainTab) return;
            
            chainTab.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="error-text">No recent data available for ${chain} chain</div>
                    <div>Please try again later or check a different token.</div>
                    <button class="retry-btn" onclick="analyzeChain('${chain}')">
                        <i class="fas fa-redo"></i>
                        Retry Analysis
                    </button>
                </div>
            `;
        }

        // Display token analysis error
        function displayTokenError(symbol) {
            const tokenTab = document.getElementById('tokenTab');
            if (!tokenTab) return;
            
            tokenTab.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="error-text">No recent data available for ${symbol} token</div>
                    <div>Please try again later or check a different token.</div>
                    <button class="retry-btn" onclick="analyzeToken('${symbol}', '${symbol}')">
                        <i class="fas fa-redo"></i>
                        Retry Analysis
                    </button>
                </div>
            `;
        }

        // Format analysis text with proper structure
        function formatAnalysisText(text) {
            // Split into paragraphs and format
            const paragraphs = text.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(paragraph => {
                // Check if it looks like a heading
                if (paragraph.length < 100 && paragraph.toUpperCase() === paragraph && paragraph.includes(':')) {
                    return `<h4>${paragraph}</h4>`;
                }
                
                // Check if it contains bullet points
                if (paragraph.includes('•') || paragraph.includes('-')) {
                    const lines = paragraph.split('\n').map(line => line.trim()).filter(line => line);
                    const listItems = lines.filter(line => line.startsWith('•') || line.startsWith('-'));
                    
                    if (listItems.length > 0) {
                        const heading = lines.find(line => !line.startsWith('•') && !line.startsWith('-'));
                        let html = heading ? `<h4>${heading}</h4>` : '';
                        html += '<ul>' + listItems.map(item => 
                            `<li>${item.replace(/^[•-]\s*/, '')}</li>`
                        ).join('') + '</ul>';
                        return html;
                    }
                }
                
                return `<p>${paragraph}</p>`;
            }).join('');
        }
    </script>
</body>
</html>